name: {{FRAMEWORK_NAME}}
scheduler:
  principal: {{FRAMEWORK_PRINCIPAL}}
  user: {{FRAMEWORK_USER}}
pods:
  mongodb:
    count: {{NODE_COUNT}}
    image: {{MONGODB_IMAGE}}
    placement: '{{{NODE_PLACEMENT}}}'
    {{#ENABLE_VIRTUAL_NETWORK}}
    networks:
      {{VIRTUAL_NETWORK_NAME}}:
        labels: {{VIRTUAL_NETWORK_PLUGIN_LABELS}}
    {{/ENABLE_VIRTUAL_NETWORK}}
    uris:
      - {{REPLICASET_SH}}
    tasks:
      mongod:
        goal: RUNNING
        cmd: |
             if [ {{NODE_COUNT}}  = 1 ]
             then
                 mongod
             elif [ {{NODE_COUNT}} -ge 1 ]
             then
                 mongod --replSet {{MONGODB_REPLICASET_NAME}} --bind_ip_all
             else
                 echo "Invalid number of nodes.MongoDB require minimum 3 nodes to run in distributed mode."
             fi
        cpus: {{NODE_CPUS}}
        memory: {{NODE_MEM}}
        ports:
          mongodb:
            port: {{MONGODB_NODE_PORT}} 
            env-key: PORT
            advertise: true
            vip:
              prefix: mongodb
              port: 27017
        volume:
          path: "mongodbservice-container-path"
          type: {{NODE_DISK_TYPE}}
          size: {{NODE_DISK}}
        env:
          SLEEP_DURATION: {{SLEEP_DURATION}}
      mongos:
        goal: ONCE 
        cmd: |
             if [ {{NODE_COUNT}} = 1 ]
             then
                 sleep 20s
                 mongo
             elif [ {{NODE_COUNT}} -ge 1 ]
             then
                 sh replicaset.sh
             else
                 echo "Invalid number of nodes.MongoDB require minimum 3 nodes to run in distributed mode."
             fi
        cpus: {{NODE_CPUS}}
        memory: {{NODE_MEM}}
        env:
          MONGODB_REPLICASET_NAME: {{MONGODB_REPLICASET_NAME}}
          MONGODB_REPLICASET_NODE: {{NODE_COUNT}}
          MONGODB_NODE_PORT: {{MONGODB_NODE_PORT}}
plans:
  deploy:
    strategy: parallel
    phases:
      master-deploy:
        strategy: parallel
        pod: mongodb
        steps:
         - default: [[mongod]]
         - 0: [[mongod], [mongos]]

